name: ä»“åº“å¤šæ“ä½œç®¡ç†å·¥å…·
on:
  workflow_dispatch:
    inputs:
      # åŠŸèƒ½å¼€å…³ï¼ˆé»˜è®¤å…¨å…³ï¼Œå¯åŒæ—¶å¼€å¯å¤šä¸ªï¼‰
      clean_all_switch:
        description: "æ¸…ç†æ‰€æœ‰å·¥ä½œæµè®°å½•"
        type: boolean
        required: true
        default: false
      clean_failed_switch:
        description: "æ¸…ç†å¤±è´¥çš„å·¥ä½œæµè®°å½•"
        type: boolean
        required: true
        default: false
      keep_5_switch:
        description: "ä¿ç•™æœ€æ–°5æ¡å·¥ä½œæµè®°å½•"
        type: boolean
        required: true
        default: false
      delete_file_switch:
        description: "åˆ é™¤å·¥ä½œæµæ–‡ä»¶"
        type: boolean
        required: true
        default: false
      clean_commits_switch:
        description: "å½»åº•æ¸…é™¤æäº¤è®°å½•ï¼ˆä¸å¯é€†ï¼‰"
        type: boolean
        required: true
        default: false
      clean_releases_switch:
        description: "ä¸€é”®æ¸…ç†ç§äººä»“åº“Releaseï¼ˆAPIç›´è¿ç‰ˆï¼‰"
        type: boolean
        required: true
        default: false
      backup_repo_switch:
        description: "ä¸€é”®å¤‡ä»½æ•´ä¸ªä»“åº“æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼ŒArtifactsä¸‹è½½ï¼‰"
        type: boolean
        required: true
        default: false
      clean_all_tags_switch:  # æ–°å¢ï¼šæ¸…ç†æ‰€æœ‰Tagå¼€å…³
        description: "ä¸€é”®æ¸…ç†ä»“åº“æ‰€æœ‰Tagï¼ˆä¸å¯é€†ï¼‰"
        type: boolean
        required: true
        default: false

      # é™„åŠ å‚æ•°ï¼ˆä»…å¯¹åº”å¼€å…³å¼€å¯æ—¶å¡«å†™ï¼‰
      file:
        description: "è¦åˆ é™¤çš„å·¥ä½œæµæ–‡ä»¶åï¼ˆä»…delete_file_switchå¼€å¯æ—¶å¡«å†™ï¼Œå¦‚test.ymlï¼‰"
        required: false
        default: ""
      main_branch:
        description: "ä»“åº“ä¸»åˆ†æ”¯åï¼ˆä»…clean_commits_switchå¼€å¯æ—¶å¡«å†™ï¼Œé»˜è®¤mainï¼‰"
        required: false
        default: "master"

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´æäº¤å†å²ï¼ˆé€‚é…æ‰€æœ‰åŠŸèƒ½ï¼‰

      # ç§»é™¤å•å¼€å…³æ ¡éªŒï¼Œæ”¯æŒå¤šå¼€å…³åŒæ—¶è¿è¡Œ
      - name: åŠŸèƒ½å¼€å…³çŠ¶æ€ç¡®è®¤
        run: |
          echo "ğŸ” å½“å‰å¼€å¯çš„åŠŸèƒ½å¼€å…³ï¼š"
          [ "${{ github.event.inputs.clean_all_switch }}" = "true" ] && echo "- æ¸…ç†æ‰€æœ‰å·¥ä½œæµè®°å½•"
          [ "${{ github.event.inputs.clean_failed_switch }}" = "true" ] && echo "- æ¸…ç†å¤±è´¥çš„å·¥ä½œæµè®°å½•"
          [ "${{ github.event.inputs.keep_5_switch }}" = "true" ] && echo "- ä¿ç•™æœ€æ–°5æ¡å·¥ä½œæµè®°å½•"
          [ "${{ github.event.inputs.delete_file_switch }}" = "true" ] && echo "- åˆ é™¤å·¥ä½œæµæ–‡ä»¶ï¼ˆæ–‡ä»¶ï¼š${{ github.event.inputs.file }}ï¼‰"
          [ "${{ github.event.inputs.clean_commits_switch }}" = "true" ] && echo "- å½»åº•æ¸…é™¤æäº¤è®°å½•ï¼ˆä¸»åˆ†æ”¯ï¼š${{ github.event.inputs.main_branch }}ï¼‰"
          [ "${{ github.event.inputs.clean_releases_switch }}" = "true" ] && echo "- æ¸…ç†ç§äººä»“åº“Release"
          [ "${{ github.event.inputs.backup_repo_switch }}" = "true" ] && echo "- å¤‡ä»½ä»“åº“æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰"
          [ "${{ github.event.inputs.clean_all_tags_switch }}" = "true" ] && echo "- æ¸…ç†ä»“åº“æ‰€æœ‰Tagï¼ˆä¸å¯é€†ï¼‰"  # æ–°å¢ï¼šæ˜¾ç¤ºå¼€å…³çŠ¶æ€
          echo "âœ… åŠŸèƒ½å¼€å…³ç¡®è®¤å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œå¯¹åº”æ“ä½œ"

      # 1. æ¸…ç†æ‰€æœ‰å·¥ä½œæµè®°å½•ï¼ˆåŸæœ‰ï¼‰
      - name: æ¸…ç†æ‰€æœ‰è®°å½•
        if: github.event.inputs.clean_all_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          WORKFLOWS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows" | jq -r '.workflows[].id // "no_workflow"')
          if [ "$WORKFLOWS" = "no_workflow" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨å·¥ä½œæµï¼Œæ— éœ€æ¸…ç†"
            exit 0
          fi
          for id in $WORKFLOWS; do
            RUNS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows/$id/runs?per_page=100" | jq -r '.workflow_runs[].id // "no_run"')
            if [ "$RUNS" = "no_run" ]; then
              echo "â„¹ï¸ å·¥ä½œæµ$idæ— è®°å½•"
              continue
            fi
            for run in $RUNS; do
              curl -s --max-time 5 -X DELETE -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$run"
            done
          done
          echo "âœ… æ‰€æœ‰è®°å½•æ¸…ç†å®Œæˆ"
      
      # 2. æ¸…ç†å¤±è´¥çš„å·¥ä½œæµè®°å½•ï¼ˆåŸæœ‰ï¼‰
      - name: æ¸…ç†å¤±è´¥è®°å½•
        if: github.event.inputs.clean_failed_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          WORKFLOWS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows" | jq -r '.workflows[].id // "no_workflow"')
          if [ "$WORKFLOWS" = "no_workflow" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨å·¥ä½œæµï¼Œæ— éœ€æ¸…ç†å¤±è´¥è®°å½•"
            exit 0
          fi
          for id in $WORKFLOWS; do
            RUNS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows/$id/runs?status=failure&per_page=100" | jq -r '.workflow_runs[].id // "no_run"')
            if [ "$RUNS" = "no_run" ]; then
              echo "â„¹ï¸ å·¥ä½œæµ$idæ— å¤±è´¥è®°å½•"
              continue
            fi
            for run in $RUNS; do
              curl -s --max-time 5 -X DELETE -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$run"
            done
          done
          echo "âœ… å¤±è´¥è®°å½•æ¸…ç†å®Œæˆ"
      
      # 3. ä¿ç•™æœ€æ–°5æ¡å·¥ä½œæµè®°å½•ï¼ˆåŸæœ‰ï¼‰
      - name: ä¿ç•™æœ€æ–°5æ¡è®°å½•
        if: github.event.inputs.keep_5_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          WORKFLOWS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows" | jq -r '.workflows[].id // "no_workflow"')
          if [ "$WORKFLOWS" = "no_workflow" ]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°å¯ç”¨å·¥ä½œæµï¼Œæ— éœ€ä¿ç•™è®°å½•"
            exit 0
          fi
          for id in $WORKFLOWS; do
            RUNS=$(curl -s --max-time 10 -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/workflows/$id/runs?per_page=100" | jq -r '.workflow_runs[].id // "no_run"')
            if [ "$RUNS" = "no_run" ]; then
              echo "â„¹ï¸ å·¥ä½œæµ$idæ— è®°å½•"
              continue
            fi
            TOTAL=$(echo "$RUNS" | wc -l)
            if [ "$TOTAL" -le 5 ]; then
              echo "â„¹ï¸ å·¥ä½œæµ$idè®°å½•æ•°â‰¤5ï¼Œæ— éœ€åˆ é™¤"
              continue
            fi
            RUNS_TO_DELETE=$(echo "$RUNS" | tail -n +6)
            for run in $RUNS_TO_DELETE; do
              curl -s --max-time 5 -X DELETE -H "Authorization: token $TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$run"
            done
          done
          echo "âœ… å·²ä¿ç•™æœ€æ–°5æ¡è®°å½•"
      
      # 4. åˆ é™¤å·¥ä½œæµæ–‡ä»¶ï¼ˆåŸæœ‰ï¼‰
      - name: åˆ é™¤å·¥ä½œæµæ–‡ä»¶
        if: github.event.inputs.delete_file_switch == 'true'
        env:
          FILE: ${{ github.event.inputs.file }}
        run: |
          if [ -z "$FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šå¼€å¯delete_file_switchåï¼Œå¿…é¡»å¡«å†™fileå‚æ•°"
            exit 1
          fi
          FILE_PATH=".github/workflows/$FILE"
          if [ -f "$FILE_PATH" ]; then
            rm -f "$FILE_PATH"
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git add . && git commit -m "Delete workflow file: $FILE" && git push
            echo "âœ… å·²åˆ é™¤æ–‡ä»¶ï¼š$FILE"
          else
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨ï¼š$FILE_PATH"
            exit 1
          fi
      
      # 5. å½»åº•æ¸…é™¤æäº¤è®°å½•ï¼ˆåŸæœ‰ï¼Œæ”¯æŒç©ºç™½æäº¤ï¼‰
      - name: å½»åº•æ¸…é™¤æäº¤è®°å½•
        if: github.event.inputs.clean_commits_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          MAIN_BRANCH: ${{ github.event.inputs.main_branch }}
        run: |
          if [ -z "$MAIN_BRANCH" ]; then
            echo "âŒ é”™è¯¯ï¼šå¼€å¯clean_commits_switchåï¼Œå¿…é¡»å¡«å†™main_branchå‚æ•°"
            exit 1
          fi
          git config --global --add safe.directory /github/workspace
          echo "âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œä¼šå½»åº•åˆ é™¤æ‰€æœ‰æäº¤å†å²ï¼Œä»…ä¿ç•™å½“å‰æ–‡ä»¶ï¼Œä¸å¯æ¢å¤ï¼"
          git config --global user.name "ettyui"
          git config --global user.email "ettyui@users.noreply.github.com"
          git checkout $MAIN_BRANCH
          git checkout --orphan temp_branch
          git add -A
          git commit --allow-empty-message -m ""
          git branch -D $MAIN_BRANCH
          git branch -m $MAIN_BRANCH
          git push -f https://x-access-token:${TOKEN}@github.com/${REPO}.git $MAIN_BRANCH
          echo "âœ… æäº¤è®°å½•å·²å½»åº•æ¸…é™¤"
      
      # 6. ä¸€é”®æ¸…ç†ç§äººä»“åº“Releaseï¼ˆåŸæœ‰ï¼‰
      - name: ä¸€é”®æ¸…ç†ç§äººä»“åº“Releaseï¼ˆAPIç›´è¿ç‰ˆï¼‰
        if: github.event.inputs.clean_releases_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # é€šè¿‡APIè·å–æ‰€æœ‰Release ID
          RELEASE_IDS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/releases" | jq '.[].id')
          
          if [ -z "$RELEASE_IDS" ] || [ "$RELEASE_IDS" = "null" ]; then
            echo "â„¹ï¸  ç§äººä»“åº“æ— Releaseå¯æ¸…ç†"
            exit 0
          fi
          
          # å¾ªç¯åˆ é™¤æ¯ä¸ªReleaseï¼ˆAPIä¼šè‡ªåŠ¨æ¸…ç†å…³è”æ ‡ç­¾ï¼‰
          for id in $RELEASE_IDS; do
            echo "ğŸ—‘ï¸  åˆ é™¤Release ID: $id"
            curl -s -X DELETE -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$REPO/releases/$id"
          done
          
          echo "âœ… ç§äººä»“åº“æ‰€æœ‰ReleaseåŠå…³è”æ ‡ç­¾å·²æ¸…ç†å®Œæˆ"
      
      # 7. å¤‡ä»½æ•´ä¸ªä»“åº“æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰
      - name: ä¸€é”®å¤‡ä»½æ•´ä¸ªä»“åº“æ–‡ä»¶
        if: github.event.inputs.backup_repo_switch == 'true'
        run: |
          echo "=== å¼€å§‹å¤‡ä»½æ•´ä¸ªä»“åº“æ–‡ä»¶ ==="
          # åˆ›å»ºå¤‡ä»½ç›®å½•ï¼Œé¿å…é€’å½’å¤åˆ¶
          rm -rf repo-backup
          mkdir -p repo-backup
          # å¤åˆ¶ä»“åº“æ–‡ä»¶ï¼ˆæ’é™¤.gitå’Œå¤‡ä»½ç›®å½•ï¼‰
          rsync -a --exclude='./.git' --exclude='./repo-backup' ./ repo-backup/
          
          # ç»Ÿè®¡å¤‡ä»½æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find repo-backup -type f | wc -l)
          echo "ğŸ“ å…±å¤‡ä»½ $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          # å‹ç¼©ä¸ºZIPåŒ…ï¼ˆå‘½ååŒ…å«ä»“åº“åå’ŒåŒ—äº¬æ—¶é—´ï¼‰
          REPO_NAME=$(echo "${{ github.repository }}" | awk -F '/' '{print $2}')
          BACKUP_NAME="${REPO_NAME}-repo-backup-$(TZ='Asia/Shanghai' date +%Y%m%d-%H%M%S).zip"
          zip -qr -1 "$BACKUP_NAME" repo-backup/
          
          echo "âœ… ä»“åº“å¤‡ä»½å®Œæˆ â†’ $BACKUP_NAME"
          echo "BACKUP_FILE=$BACKUP_NAME" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV

      # 8. ä¸Šä¼ å¤‡ä»½åŒ…ï¼ˆå¯ç›´æ¥ä¸‹è½½ï¼‰
      - name: ä¸Šä¼ ä»“åº“å¤‡ä»½åŒ…
        if: github.event.inputs.backup_repo_switch == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BACKUP_FILE }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 30  # å¤‡ä»½åŒ…ä¿ç•™30å¤©ï¼Œåˆ°æœŸè‡ªåŠ¨åˆ é™¤

      # 9. å¤‡ä»½å®Œæˆè¾“å‡º
      - name: å¤‡ä»½å®Œæˆæç¤º
        if: github.event.inputs.backup_repo_switch == 'true'
        run: |
          echo "âœ… ä»“åº“å¤‡ä»½æˆåŠŸï¼å…±å¤‡ä»½ ${{ env.FILE_COUNT }} ä¸ªæ–‡ä»¶"
          echo "ğŸ“¥ å¯åœ¨ä¸‹æ–¹â€œArtifactsâ€ä¸­ä¸‹è½½å¤‡ä»½åŒ…ï¼ˆä¿ç•™30å¤©ï¼‰"
          echo "âš ï¸  å¤‡ä»½åŒ…å«ä»“åº“æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤.gitï¼‰ï¼Œå»ºè®®æœ¬åœ°å¦è¡Œå­˜æ¡£"

      # æ–°å¢ï¼š10. ä¸€é”®æ¸…ç†ä»“åº“æ‰€æœ‰Tagï¼ˆä¸å¯é€†ï¼‰
      - name: ä¸€é”®æ¸…ç†ä»“åº“æ‰€æœ‰Tag
        if: github.event.inputs.clean_all_tags_switch == 'true'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œä¼šåˆ é™¤ä»“åº“æ‰€æœ‰Tagï¼Œä¸å¯æ¢å¤ï¼"
          # é€šè¿‡APIè·å–æ‰€æœ‰Tagåç§°ï¼ˆæ’é™¤è½»é‡çº§æ ‡ç­¾ï¼Œç¡®ä¿å…¨è¦†ç›–ï¼‰
          TAG_NAMES=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/tags" | jq -r '.[].name')
          
          if [ -z "$TAG_NAMES" ] || [ "$TAG_NAMES" = "null" ] || [ "$TAG_NAMES" = "" ]; then
            echo "â„¹ï¸  ä»“åº“æ— Tagå¯æ¸…ç†"
            exit 0
          fi
          
          # å¾ªç¯åˆ é™¤æ¯ä¸ªTagï¼ˆæ”¯æŒæ‰¹é‡åˆ é™¤ï¼Œè·³è¿‡ç©ºå€¼ï¼‰
          echo "ğŸ—‘ï¸  å¼€å§‹åˆ é™¤æ‰€æœ‰Tagï¼š"
          echo "$TAG_NAMES" | while read -r tag; do
            if [ -n "$tag" ]; then
              echo "â†’ åˆ é™¤Tag: $tag"
              curl -s -X DELETE -H "Authorization: token $TOKEN" \
                "https://api.github.com/repos/$REPO/git/refs/tags/$tag"
            fi
          done
          
          echo "âœ… ä»“åº“æ‰€æœ‰Tagå·²æ¸…ç†å®Œæˆ"